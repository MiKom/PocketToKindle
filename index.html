<html>

<head>
    <title>Pocket to kindle</title>
    <meta charset="UTF-8">
    <style>
        .wrapper {
            font-family: Tahoma;
            max-width: 50em;
            margin: 0 auto;
        }

        .footer {
            text-align: center;
        }

        .footer a {
            color: grey;
        }

        button {
            padding: 0.5em 2em;
        }

        li {
            margin-bottom: 0.8em;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <h1>
            Pocket to kindle
        </h1>
        <div>
            Pocket to kindle sends your pocket articles to your kindle!
        </div>

        <h2>Register</h2>
        <ol>
            <li>
                First,
                <button id="authorize-pocket-button">Authorize Pocket</button>
            </li>
            <li>
                Next go to
                <a href="https://www.amazon.com/hz/mycd/myx#/home/settings/payment">Kindle email allowed senders</a> under "Personal Document Settings" and add "kindle@mail.sejkapp.pl" as approved
                email.
            </li>
            <li>
                Finally, find your kindle email in "Your Devices" tab and share it below:
                <br/>
                <input id="email-input" type="text">
                <br />
                <button id="submit-button" disabled>Submit</button>
            </li>
            <li>
                That's it! If everything went fine you should receive an welcoming email on your kindle. Next time you add something to your
                pocket it should arrive within 15 minutes on your kindle. Enjoy!
            </li>
        </ol>
        <div class="footer">
            <a href="https://github.com/sejka/pockettokindle">Source code</a>
            <a href="https://twitter.com/karolsejka">Karol Sejka</a>
        </div>
    </div>
    <script type="text/javascript">
        var authorizeButton = document.getElementById('authorize-pocket-button');
        var submitButton = document.getElementById('submit-button');
        submitButton.onclick = register;
        authorizeButton.onclick = authroizeOnPocket;

        if (getCookie("pocketkey")) {
            submitButton.disabled = false;
        }

        function register() {
            var xhReq = new XMLHttpRequest();
            xhReq.open("POST",
                "https://pocket-to-kindle.azurewebsites.net/api/Register",
                false);
            xhReq.setRequestHeader("Content-Type", "application/json");

            var kindleEmail = document.getElementById('email-input').value;
            var url = new URL(window.location.href);
            var requestCode = document.cookie;

            var data = JSON.stringify({
                "kindleEmail": kindleEmail,
                "requestCode": requestCode
            });
            xhReq.send(data);
            var serverResponse = xhReq.responseText;
            alert(serverResponse);
        }

        async function authroizeOnPocket() {
            url = "https://pocket-to-kindle.azurewebsites.net/api/GetRegistrationInfo";
            let response = await fetch(url);
            response = await response.json();
            document.cookie = `pocketkey=${response.RequestCode}`;
            window.location.href = response.RegistrationLink;
        }

        function getCookie (name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length == 2) return parts.pop().split(";").shift();
        };
    </script>
</body>

</html>